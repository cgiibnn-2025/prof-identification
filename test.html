<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Application ESU-RSI</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .test-item {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #2563eb;
            background: #f8f9ff;
        }
        .success { border-left-color: #059669; background: #f0fdf4; }
        .error { border-left-color: #dc2626; background: #fef2f2; }
        .warning { border-left-color: #d97706; background: #fef3c7; }
        h1, h2 { color: #2563eb; }
        .status { font-weight: bold; }
        .btn {
            background: #2563eb;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .btn:hover { background: #1d4ed8; }
        .btn-secondary { background: #64748b; }
        .btn-secondary:hover { background: #475569; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test de l'Application ESU-RSI</h1>
        <p>Cette page permet de tester les fonctionnalit√©s de l'application de gestion du personnel acad√©mique.</p>
        
        <h2>üìã Tests automatiques</h2>
        <div id="testResults"></div>
        
        <h2>üîó Actions de test</h2>
        <button class="btn" onclick="testDatabase()">Tester la base de donn√©es</button>
        <button class="btn" onclick="testFileLoading()">Tester le chargement des fichiers</button>
        <button class="btn" onclick="testValidation()">Tester la validation</button>
        <button class="btn btn-secondary" onclick="clearData()">Effacer les donn√©es de test</button>
        
        <div style="margin-top: 30px; text-align: center;">
            <a href="index.html" class="btn">üè† Retour √† l'application principale</a>
        </div>
        
        <h2>üìä Informations syst√®me</h2>
        <div id="systemInfo"></div>
    </div>

    <script>
        // Tests automatiques au chargement
        document.addEventListener('DOMContentLoaded', () => {
            runAutomaticTests();
            displaySystemInfo();
        });

        async function runAutomaticTests() {
            const results = document.getElementById('testResults');
            results.innerHTML = '';

            // Test 1: Chargement de SQL.js
            addTestResult('Chargement de SQL.js', await testSQLJS(), results);
            
            // Test 2: LocalStorage disponible
            addTestResult('LocalStorage disponible', testLocalStorage(), results);
            
            // Test 3: Fetch API disponible
            addTestResult('Fetch API disponible', testFetchAPI(), results);
            
            // Test 4: FileReader API disponible
            addTestResult('FileReader API disponible', testFileReader(), results);
            
            // Test 5: Chargement du fichier universit√©s
            addTestResult('Chargement etab.json', await testUniversitiesFile(), results);
        }

        async function testSQLJS() {
            try {
                if (typeof initSqlJs !== 'undefined') {
                    return { success: true, message: 'SQL.js est disponible' };
                } else {
                    return { success: false, message: 'SQL.js n\'est pas charg√©' };
                }
            } catch (error) {
                return { success: false, message: `Erreur SQL.js: ${error.message}` };
            }
        }

        function testLocalStorage() {
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                return { success: true, message: 'LocalStorage fonctionne correctement' };
            } catch (error) {
                return { success: false, message: `LocalStorage indisponible: ${error.message}` };
            }
        }

        function testFetchAPI() {
            if (typeof fetch !== 'undefined') {
                return { success: true, message: 'Fetch API disponible' };
            } else {
                return { success: false, message: 'Fetch API non support√©e' };
            }
        }

        function testFileReader() {
            if (typeof FileReader !== 'undefined') {
                return { success: true, message: 'FileReader API disponible' };
            } else {
                return { success: false, message: 'FileReader API non support√©e' };
            }
        }

        async function testUniversitiesFile() {
            try {
                const response = await fetch('./etab.json');
                if (response.ok) {
                    const data = await response.json();
                    if (Array.isArray(data) && data.length > 0) {
                        return { 
                            success: true, 
                            message: `Fichier universit√©s charg√© (${data.length} universit√©s)` 
                        };
                    } else {
                        return { success: false, message: 'Fichier universit√©s vide ou invalide' };
                    }
                } else {
                    return { success: false, message: `Erreur HTTP: ${response.status}` };
                }
            } catch (error) {
                return { success: false, message: `Erreur de chargement: ${error.message}` };
            }
        }

        function addTestResult(testName, result, container) {
            const div = document.createElement('div');
            div.className = `test-item ${result.success ? 'success' : 'error'}`;
            div.innerHTML = `
                <strong>${testName}:</strong> 
                <span class="status">${result.success ? '‚úÖ SUCC√àS' : '‚ùå √âCHEC'}</span><br>
                ${result.message}
            `;
            container.appendChild(div);
        }

        async function testDatabase() {
            const results = document.getElementById('testResults');
            
            try {
                // Simuler l'initialisation de la base de donn√©es
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });
                
                const db = new SQL.Database();
                
                // Cr√©er une table de test
                db.run(`
                    CREATE TABLE test_table (
                        id INTEGER PRIMARY KEY,
                        name TEXT
                    )
                `);
                
                // Ins√©rer des donn√©es de test
                db.run("INSERT INTO test_table (name) VALUES ('Test 1'), ('Test 2')");
                
                // Lire les donn√©es
                const stmt = db.prepare("SELECT * FROM test_table");
                const rows = [];
                while (stmt.step()) {
                    rows.push(stmt.getAsObject());
                }
                stmt.free();
                
                addTestResult(
                    'Test de base de donn√©es', 
                    { 
                        success: true, 
                        message: `Base de donn√©es SQLite op√©rationnelle. ${rows.length} enregistrements de test cr√©√©s.` 
                    }, 
                    results
                );
                
                db.close();
            } catch (error) {
                addTestResult(
                    'Test de base de donn√©es', 
                    { 
                        success: false, 
                        message: `Erreur: ${error.message}` 
                    }, 
                    results
                );
            }
        }

        async function testFileLoading() {
            const results = document.getElementById('testResults');
            
            try {
                // Test de chargement des logos
                const logoTest = new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => resolve(true);
                    img.onerror = () => resolve(false);
                    img.src = './app-logo.png';
                });
                
                const logoLoaded = await logoTest;
                
                addTestResult(
                    'Chargement des fichiers', 
                    { 
                        success: logoLoaded, 
                        message: logoLoaded ? 'Logo principal charg√© avec succ√®s' : 'Impossible de charger le logo principal' 
                    }, 
                    results
                );
            } catch (error) {
                addTestResult(
                    'Chargement des fichiers', 
                    { 
                        success: false, 
                        message: `Erreur: ${error.message}` 
                    }, 
                    results
                );
            }
        }

        function testValidation() {
            const results = document.getElementById('testResults');
            
            // Test des expressions r√©guli√®res de validation
            const telephoneRegex = /^(\+243|0)[0-9]{9}$/;
            
            const telephoneTests = [
                { value: '+243123456789', expected: true },
                { value: '0123456789', expected: true },
                { value: '123456789', expected: false },
                { value: '+24312345678', expected: false }
            ];
            
            let telephoneSuccess = telephoneTests.every(test => 
                telephoneRegex.test(test.value) === test.expected
            );
            
            addTestResult(
                'Validation t√©l√©phone', 
                { 
                    success: telephoneSuccess, 
                    message: telephoneSuccess ? 'Validation t√©l√©phone fonctionnelle' : 'Erreur validation t√©l√©phone' 
                }, 
                results
            );
            
            addTestResult(
                'Validation matricule', 
                { 
                    success: true, 
                    message: 'Contrainte matricule supprim√©e - tous formats accept√©s' 
                }, 
                results
            );
        }

        function clearData() {
            if (confirm('√ätes-vous s√ªr de vouloir effacer toutes les donn√©es de test ?')) {
                localStorage.removeItem('professeurs_db');
                alert('Donn√©es de test effac√©es avec succ√®s !');
                location.reload();
            }
        }

        function displaySystemInfo() {
            const info = document.getElementById('systemInfo');
            
            info.innerHTML = `
                <div class="test-item">
                    <strong>Navigateur:</strong> ${navigator.userAgent}<br>
                    <strong>Langue:</strong> ${navigator.language}<br>
                    <strong>Plateforme:</strong> ${navigator.platform}<br>
                    <strong>Cookies activ√©s:</strong> ${navigator.cookieEnabled ? 'Oui' : 'Non'}<br>
                    <strong>En ligne:</strong> ${navigator.onLine ? 'Oui' : 'Non'}<br>
                    <strong>LocalStorage:</strong> ${typeof(Storage) !== "undefined" ? 'Support√©' : 'Non support√©'}<br>
                    <strong>Service Worker:</strong> ${'serviceWorker' in navigator ? 'Support√©' : 'Non support√©'}<br>
                    <strong>Taille √©cran:</strong> ${screen.width}x${screen.height}<br>
                    <strong>Taille fen√™tre:</strong> ${window.innerWidth}x${window.innerHeight}
                </div>
            `;
        }
    </script>
    
    <!-- Chargement de SQL.js pour les tests -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
</body>
</html>
